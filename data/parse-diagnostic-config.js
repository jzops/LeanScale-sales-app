const fs = require('fs');
const path = require('path');

const REQUIRED_HEADERS = {
  processes: ['process', 'status', 'include', 'function', 'service_id'],
  tools: ['tool', 'status', 'include', 'service_id'],
  managed: ['service', 'status', 'include', 'hours_month', 'service_id']
};

function parseMarkdownTable(lines, startIndex, sectionName) {
  const rows = [];
  let headers = [];
  let i = startIndex;
  const warnings = [];
  
  while (i < lines.length && lines[i].trim().startsWith('|')) {
    const line = lines[i].trim();
    const cells = line.split('|').slice(1, -1).map(c => c.trim());
    
    if (headers.length === 0) {
      headers = cells.map(h => h.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, ''));
      
      const required = REQUIRED_HEADERS[sectionName] || [];
      const missing = required.filter(h => !headers.includes(h));
      if (missing.length > 0) {
        console.warn('  WARNING: Missing headers in ' + sectionName + ': ' + missing.join(', '));
      }
      
      i++;
      if (lines[i] && lines[i].includes('---')) i++;
      continue;
    }
    
    const row = {};
    cells.forEach((cell, idx) => {
      if (headers[idx]) {
        row[headers[idx]] = cell;
      }
    });
    
    if (Object.values(row).some(v => v && v.length > 0)) {
      rows.push(row);
    }
    i++;
  }
  
  return { rows, endIndex: i, warnings };
}

function parseConfig() {
  const configPath = path.join(__dirname, 'diagnostic-config.md');
  const content = fs.readFileSync(configPath, 'utf8');
  const lines = content.split('\n');
  
  let processes = [];
  let tools = [];
  let managedServices = [];
  
  let currentSection = null;
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    
    if (line.startsWith('## Processes')) {
      currentSection = 'processes';
    } else if (line.startsWith('## Tools')) {
      currentSection = 'tools';
    } else if (line.startsWith('## Managed Services')) {
      currentSection = 'managed';
    } else if (line.startsWith('## Status Legend') || line.startsWith('## How to Edit')) {
      currentSection = null;
    } else if (line.startsWith('|') && currentSection) {
      const { rows, endIndex } = parseMarkdownTable(lines, i, currentSection);
      
      if (currentSection === 'processes') {
        processes = rows.map(r => ({
          name: r.process || '',
          status: r.status || 'healthy',
          addToEngagement: r.include === 'âœ“',
          function: r.function || 'Cross Functional',
          outcome: r.outcome || '',
          metric: r.metric || '',
          serviceId: r.service_id || '',
          serviceType: 'strategic'
        }));
      } else if (currentSection === 'tools') {
        tools = rows.map(r => ({
          name: r.tool || '',
          status: r.status || 'healthy',
          addToEngagement: r.include === 'âœ“',
          category: r.category || '',
          serviceId: r.service_id || ''
        }));
      } else if (currentSection === 'managed') {
        managedServices = rows.map(r => ({
          name: r.service || '',
          status: r.status || 'healthy',
          addToEngagement: r.include === 'âœ“',
          hoursPerMonth: parseInt(r.hours_month) || 8,
          serviceId: r.service_id || '',
          serviceType: 'managed'
        }));
      }
      
      i = endIndex - 1;
      currentSection = null;
    }
  }
  
  return { processes, tools, managedServices };
}

function generateDataFile() {
  console.log('Parsing diagnostic-config.md...');
  const { processes, tools, managedServices } = parseConfig();
  
  if (processes.length === 0) {
    console.error('  ERROR: No processes found in diagnostic-config.md');
  }
  if (managedServices.length === 0) {
    console.error('  ERROR: No managed services found in diagnostic-config.md');
  }
  
  const emptyNames = [
    ...processes.filter(p => !p.name).map(() => 'process'),
    ...tools.filter(t => !t.name).map(() => 'tool'),
    ...managedServices.filter(m => !m.name).map(() => 'managed service')
  ];
  if (emptyNames.length > 0) {
    console.warn('  WARNING: ' + emptyNames.length + ' items have empty names');
  }
  
  const output = `// AUTO-GENERATED from diagnostic-config.md
// Do not edit this file directly - edit data/diagnostic-config.md instead

export const gtmFunctions = [
  'Cross Functional',
  'Marketing',
  'Sales',
  'Customer Success',
  'Partnerships',
];

export const gtmOutcomes = [
  'Increase Pipeline',
  'Improve Sales Efficiency',
  'Reduce Churn',
  'Improve Data Quality',
  'Scale Operations',
  'Optimize Reporting',
];

export const power10MetricNames = [
  'ARR',
  'Bookings',
  'Gross churn',
  'Gross retention',
  'MQL -> Opportunity conversion rate',
  'MQL production',
  'Net retention',
  'Opportunity/Deal - CW cycle time',
  'Opportunity/Deal -> CW conversion rate',
  'Pipeline production',
];

export const power10Metrics = power10MetricNames.map(name => ({ name }));

export const processes = ${JSON.stringify(processes, null, 2)};

export const tools = ${JSON.stringify(tools, null, 2)};

export const managedServicesHealth = ${JSON.stringify(managedServices, null, 2)};

export function countStatuses(items) {
  return items.reduce(
    (acc, item) => {
      if (item.status === 'healthy') acc.healthy++;
      else if (item.status === 'careful') acc.careful++;
      else if (item.status === 'warning') acc.warning++;
      else if (item.status === 'unable' || item.status === 'na') acc.unable++;
      return acc;
    },
    { healthy: 0, careful: 0, warning: 0, unable: 0 }
  );
}

export function groupBy(items, field) {
  return items.reduce((acc, item) => {
    const key = item[field] || 'Other';
    if (!acc[key]) acc[key] = [];
    acc[key].push(item);
    return acc;
  }, {});
}

export function getPriorityItems() {
  const priorityProcesses = processes.filter(p => p.addToEngagement);
  const priorityManaged = managedServicesHealth.filter(m => m.addToEngagement);
  return { priorityProcesses, priorityManaged };
}

export function emojiToStatus(emoji) {
  if (emoji === 'ðŸŸ¢') return 'healthy';
  if (emoji === 'ðŸŸ¡') return 'careful';
  if (emoji === 'ðŸ”´') return 'warning';
  if (emoji === 'âš«') return 'unable';
  return 'na';
}

export function statusToLabel(status) {
  if (status === 'healthy') return 'Healthy';
  if (status === 'careful') return 'Careful';
  if (status === 'warning') return 'Warning';
  if (status === 'unable') return 'Unable to Report';
  return 'N/A';
}
`;

  fs.writeFileSync(path.join(__dirname, 'diagnostic-data.js'), output);
  console.log('Generated diagnostic-data.js from diagnostic-config.md');
  console.log('  - ' + processes.length + ' processes');
  console.log('  - ' + tools.length + ' tools');
  console.log('  - ' + managedServices.length + ' managed services');
}

if (require.main === module) {
  generateDataFile();
}

module.exports = { parseConfig, generateDataFile };
